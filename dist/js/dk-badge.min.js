class DKBadge{constructor(t={}){let{style:e,renderUI:s,removable:i,pue:o,audienceLocationProportion:a,serverLocationProportion:n}=Object.assign({style:"full",renderUI:true,removable:false,pue:1.69,audienceLocationProportion:{france:.45,europe:0,international:.55},serverLocationProportion:{france:.5,international:.5}},t);this.node=document.querySelector("[data-dk-badge]");this.style=e;this.pue=o;this.removable=i;this.audienceLocationProportion=a;this.serverLocationProportion=n;this.renderUI=s;this.labels={intro:"This website has a carbon footprint of",emitted:"emitted",details:"Details",weight:"Weight",time:"Time",device:"Device",unknown:"unknown",CO2unit:"g CO2e",weightUnit:"Ko",timeUnit:"sec.",privacy:"no data is collected",close:"Remove the badge",...t.labels};this.weight=0;this.timeSpent=0;this.deviceType="desktop";this.ges=0;this.updateIntervalId=null;this.performanceObserver=null;this.lastCalculatedTimestamp=null;this.events={calculated:new CustomEvent("dkBadge:calculated",{detail:this}),updated:new CustomEvent("dkBadge:updated",{detail:this}),removed:new CustomEvent("dkBadge:removed",{detail:this})};this.factors={server_lifecycle:.023,server_bandwidth:125e3,france_server_efficiency:6.69e-8,international_server_efficiency:7.1e-9,france_electricity_carbon_intensity:.052,world_electricity_carbon_intensity:.357,europe_electricity_carbon_intensity:.42,network_lifecycle_impact:4.78e-9,wifi_consumption:413e-14,g4_consumption:111e-13,server_country_network_ratio:.55,viewing_country_network_ratio:.45,mobile_build_emissions:32.8,desktop_build_emissions:156,tablet_build_emissions:63.2,mobile_end_of_life_emissions:.71,desktop_end_of_life_emissions:2.1,tablet_end_of_life_emissions:.7,mobile_daily_usage:2.7,mobile_year_usage:365,mobile_lifetime:2.5,desktop_lifetime:5,desktop_daily_usage:2.02,desktop_year_usage:253,tablet_lifetime:3,tablet_daily_usage:1.5,tablet_year_usage:365,mobile_power:4.5,desktop_power:29.4,tablet_power:29.4}}render(){if(!this.renderUI)return;if(!this.node)return;this.node.id="dk-badge-wrapper";const t=`\n\t\t\t<button class="dk-badge_remove" data-dk-badge-remove>\n\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="m1 1 18 18M1 19 19 1"/></svg>\n\t\t\t\t<span class="sr-only">${this.labels.close}</span>\n\t\t\t</button>`;const e=`\n\t\t\t<div class="dk-badge is-${this.style} ${this.removable?"is-removable":""}">\n\t\t\t\t<p class="dk-badge_title">\n\t\t\t\t\t<span>${this.labels.intro}</span>\n\t\t\t\t\t<span class="dk-badge_co2" data-dk-badge-CO2>${this.labels.unknown}</span>\n\t\t\t\t\t<span class="dk-badge_co2_unit">${this.labels.emitted}</span>\n\t\t\t\t</p>\n\t\t\t\t${this.removable?t:""}\n\t\t\t\t<button class="dk-badge_button" aria-controls="dk-badge" aria-expanded="false" data-dk-badge-button>\n\t\t\t\t\t<svg xmlns='http://www.w3.org/2000/svg' viewBox="-2 -2 20 20" fill='none' stroke='currentColor' stroke-linecap='round' stroke-width='2'>\n\t\t\t\t\t\t<path d="M-2 8h20" class="h"/>\n\t\t\t\t\t\t<path d="M-2 8h20" class="v"/>\n\t\t\t\t\t\t<path d="M16 4L8 12L0 4" class="c"/> \n\t\t\t\t\t</svg>\n\t\t\t\t\t<span class="sr-only">${this.labels.details}</span>\n\t\t\t\t</button>\n\t\t\t\t<div class="dk-badge_content" data-dk-badge-content id="dk-badge">\n\t\t\t\t\t<hr class="dk-badge_hr" role="presentation">\n\t\t\t\t\t<p class="dk-badge_data">${this.labels.weight}&nbsp;:&nbsp;<strong data-dk-badge-weight>${this.labels.unknown}</strong></p>\n\t\t\t\t\t<p class="dk-badge_data">${this.labels.time}&nbsp;:&nbsp;<strong data-dk-badge-time>${this.labels.unknown}</strong></p>\n\t\t\t\t\t<p class="dk-badge_data">${this.labels.device}&nbsp;:&nbsp;<strong data-dk-badge-device>${this.labels.unknown}</strong></p>\n\t\t\t\t\t<hr class="dk-badge_hr" role="presentation">\n\t\t\t\t\t<p class="dk-badge_data"><a href="https://d-k.io/ressources/badge-dk?mtm_campaign=Badge-DK&mtm_source=${document.location}">Powered by DK</a> <span class="is-small">${this.labels.privacy}</span></p>\n\t\t\t\t</div>\n\t\t\t</div>`;this.node.innerHTML=e}getUserDevice(){const t=navigator.userAgent.toLowerCase();const e=/iphone|android/.test(t)?"Mobile":false;const s=/(ipad|tablet|(android(?!.*mobile))|(windows(?!.*phone)(.*touch))|kindle|playbook|silk|(puffin(?!.*(IP|AP|WP))))/.test(t)?"Tablet":false;return e||s||"Desktop"}getStoredData(){let t=sessionStorage.getItem("dk-badge");if(t){t=JSON.parse(t);this.timeSpent=t.timeSpent;this.weight=t.weight}}storeData(){sessionStorage.setItem("dk-badge",JSON.stringify({timeSpent:this.timeSpent,weight:this.weight}))}calculate(t=this.weight,e=this.timeSpent,s=this.deviceType){const i=t/1e3;const o={wifi_proportion:.9,g4_proportion:.1,mobile_proportion:s==="Mobile"?1:0,desktop_proportion:s==="Desktop"?1:0,tablet_proportion:s==="Tablet"?1:0};const a={acv:i/this.factors.server_bandwidth*this.factors.server_lifecycle/1e3,usage:(this.serverLocationProportion.france*this.factors.france_server_efficiency*this.factors.france_electricity_carbon_intensity+this.serverLocationProportion.international*this.factors.international_server_efficiency*this.factors.world_electricity_carbon_intensity)*(this.pue*i)};const n=o.wifi_proportion*this.factors.wifi_consumption*8e3;const r=o.g4_proportion*this.factors.g4_consumption*8e3;const l=o.wifi_proportion+o.g4_proportion;const d=this.serverLocationProportion.france*this.factors.france_electricity_carbon_intensity;const c=this.serverLocationProportion.international*this.factors.world_electricity_carbon_intensity;const h=this.serverLocationProportion.france+this.serverLocationProportion.international;const p=this.audienceLocationProportion.france*this.factors.france_electricity_carbon_intensity;const _=this.audienceLocationProportion.europe*this.factors.europe_electricity_carbon_intensity;const u=this.audienceLocationProportion.international*this.factors.world_electricity_carbon_intensity;const b={acv:this.factors.network_lifecycle_impact*i,usage:i*((n+r)/l)*(this.factors.server_country_network_ratio*(d+c)/h+this.factors.viewing_country_network_ratio*(p+_+u))};const g=o.mobile_proportion+o.desktop_proportion+o.tablet_proportion;const m=this.factors.mobile_build_emissions+this.factors.mobile_end_of_life_emissions;const f=this.factors.mobile_daily_usage*this.factors.mobile_year_usage*this.factors.mobile_lifetime;const v=o.mobile_proportion*m/f;const k=o.mobile_proportion*this.factors.mobile_power;const y=this.factors.desktop_build_emissions+this.factors.desktop_end_of_life_emissions;const w=this.factors.desktop_daily_usage*this.factors.desktop_year_usage*this.factors.desktop_lifetime;const I=o.desktop_proportion*y/w;const L=o.desktop_proportion*this.factors.desktop_power;const S=this.factors.tablet_build_emissions+this.factors.tablet_end_of_life_emissions;const C=this.factors.tablet_daily_usage*this.factors.tablet_year_usage*this.factors.tablet_lifetime;const P=o.tablet_proportion*S/C;const E=o.tablet_proportion*this.factors.tablet_power;const T={acv:e*(v+I+P)/g/3600,usage:e/3600*((k+L+E)/g)*(p/1e3+_/1e3+u/1e3)};this.ges=(a.acv+a.usage+b.acv+b.usage+T.acv+T.usage)*1e3;this.lastCalculatedTimestamp=performance.now();document.dispatchEvent(this.events.calculated);return this.ges}updateElement(t,e){if(!this.renderUI)return;const s=this.node.querySelector(`[data-dk-badge-${t}]`);if(!s)return;s.innerHTML=e}update(){if(!this.renderUI)return;var t=[{key:"CO2",value:this.ges.toFixed(2)+" "+this.labels.CO2unit},{key:"time",value:this.timeSpent+" "+this.labels.timeUnit},{key:"device",value:this.deviceType},{key:"weight",value:(this.weight/1e3).toFixed(2)+" "+this.labels.weightUnit}];t.forEach((t=>{this.updateElement(t.key,t.value)}));document.dispatchEvent(this.events.updated)}getResources(t=performance.getEntries()){if(!t)return;if(t.length!==0){t.forEach(((t,e)=>{if("transferSize"in t){this.weight=this.weight+t.transferSize}}))}this.calculate()}performanceObserverCallback(t){this.getResources(t.getEntries())}updateInterval(){return setInterval((()=>{this.timeSpent+=1;this.storeData();if(performance.now()-this.lastCalculatedTimestamp>=5e3){this.getResources([])}else{this.updateElement("time",this.timeSpent+" "+this.labels.timeUnit)}}),1e3)}handleVisibilityChange(){if(document.hidden){clearInterval(this.updateIntervalId);this.updateIntervalId=null}else{this.updateIntervalId=this.updateIntervalId||this.updateInterval()}}removeBadge(){localStorage.setItem("dk-badge","removed");sessionStorage.removeItem("dk-badge");this.weight=0;this.timeSpent=0;this.ges=0;this.node.innerHTML="";clearInterval(this.updateIntervalId);this.updateIntervalId=null;this.performanceObserver.disconnect()}isRemoved(){return localStorage.getItem("dk-badge")==="removed"}disclosure(t,e="toggle"){let s=t.getAttribute("aria-expanded");s=s=="true"?true:false;const i=e==="toggle"?!s:false;const o=t.getAttribute("aria-controls");const a=document.getElementById(o);if(!a)return;t.setAttribute("aria-expanded",i);a.setAttribute("data-expanded",i);if(i===true&&this.style==="footer"){window.scrollBy(0,a.getBoundingClientRect().height+16)}}disclosureInit(){const t=this.node.querySelector("[data-dk-badge-button]");if(!t)return;document.addEventListener("click",(e=>{if(e.target.closest("[data-dk-badge-button]")){this.disclosure(t)}else if(!e.target.closest("[data-dk-badge]")&&!e.target.closest("[data-dk-badge-remove]")){this.disclosure(t,"close")}else if(e.target.closest("[data-dk-badge-remove]")){this.removeBadge();document.dispatchEvent(this.events.removed)}}));document.addEventListener("keydown",(e=>{const s=27;if(e.keyCode===s){this.disclosure(t,"close")}}));document.addEventListener("blur",(e=>{if(e.relatedTarget&&!e.relatedTarget.closest("[data-dk-badge]")){this.disclosure(t,"close")}}),true)}init(){if(this.isRemoved())return;this.render();this.performanceObserver=new PerformanceObserver((t=>{this.performanceObserverCallback.call(this,t)}));this.disclosureInit();this.handleVisibilityChange();document.addEventListener("visibilitychange",(t=>{this.handleVisibilityChange.call(this,t)}),false);document.addEventListener("dkBadge:calculated",(t=>{this.update.call(this,t)}));setTimeout((()=>{this.deviceType=this.getUserDevice();this.getStoredData();this.getResources();this.performanceObserver.observe({entryTypes:["resource","navigation"]})}),500)}}